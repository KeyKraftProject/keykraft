<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Keykraft â€¢ Sphere (Households)</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="min-h-screen bg-slate-50 text-slate-900">
  <!-- Header -->
  <header class="bg-white border-b">
    <div class="max-w-6xl mx-auto px-4 py-4 flex items-center justify-between gap-4">
      <h1 class="text-xl font-semibold">Sphere</h1>
      <nav class="text-sm">
        <a class="underline opacity-80" href="./household.html?id=hh_demo">Open demo household</a>
      </nav>
    </div>
  </header>

  <!-- Toolbar -->
  <main class="max-w-6xl mx-auto p-4 md:p-6">
    <div class="flex flex-col md:flex-row md:items-end gap-3 md:gap-4 mb-4">
      <label class="block">
        <span class="text-sm">Search</span>
        <input id="q" class="mt-1 w-full md:w-96 rounded-lg border px-3 py-2" placeholder="Household, member, city, tagâ€¦" />
      </label>
      <label class="block">
        <span class="text-sm">Overdue only</span>
        <input id="overdue" type="checkbox" class="ml-2 align-middle">
      </label>

      <div class="md:ml-auto"></div>
      <button id="openAddBtn" class="px-3 py-2 rounded-lg bg-indigo-600 text-white">+ Add household</button>
    </div>

    <!-- Grid -->
    <div id="grid" class="grid sm:grid-cols-2 lg:grid-cols-3 gap-4"></div>

    <!-- Errors -->
    <p id="error" class="mt-6 text-sm text-red-700 hidden"></p>
    <p id="status" class="mt-2 text-sm text-slate-700"></p>
  </main>

  <!-- Create Household Modal -->
  <!-- use inline style to *truly* hide overlay so it can't eat clicks -->
  <div id="hhModal" class="fixed inset-0 bg-black/40 items-center justify-center p-4" style="display:none">
    <div class="bg-white w-full max-w-xl rounded-2xl p-4">
      <div class="flex items-center justify-between">
        <h2 class="text-lg font-semibold">Create household</h2>
        <button id="closeAddBtn" class="text-slate-600">âœ•</button>
      </div>

      <form id="hhCreateForm" class="mt-4 space-y-3">
        <!-- Household basics -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
          <label class="text-sm">Household name
            <input id="new_hh_name" class="mt-1 w-full rounded-lg border px-3 py-2" placeholder="Richardsâ€“Brown Household"/>
          </label>
          <label class="text-sm">Cadence (days)
            <input id="new_cadence" type="number" min="0" value="45" class="mt-1 w-full rounded-lg border px-3 py-2"/>
          </label>
          <label class="text-sm md:col-span-2">Street
            <input id="new_street" class="mt-1 w-full rounded-lg border px-3 py-2"/>
          </label>
          <label class="text-sm">City
            <input id="new_city" class="mt-1 w-full rounded-lg border px-3 py-2"/>
          </label>
          <label class="text-sm">State
            <input id="new_state" class="mt-1 w-full rounded-lg border px-3 py-2"/>
          </label>
          <label class="text-sm">ZIP
            <input id="new_zip" class="mt-1 w-full rounded-lg border px-3 py-2"/>
          </label>
          <label class="text-sm md:col-span-2">Tags (comma or semicolon)
            <input id="new_tags" class="mt-1 w-full rounded-lg border px-3 py-2" placeholder="north_shore;newsletter"/>
          </label>
        </div>

        <hr class="my-2"/>

        <!-- Optional first member -->
        <details open class="rounded-lg bg-slate-50 p-3">
          <summary class="cursor-pointer text-sm font-medium">Add first person (optional)</summary>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-3 mt-3">
            <label class="text-sm">First name
              <input id="new_p_first" class="mt-1 w-full rounded-lg border px-3 py-2"/>
            </label>
            <label class="text-sm">Last name
              <input id="new_p_last" class="mt-1 w-full rounded-lg border px-3 py-2"/>
            </label>
            <label class="text-sm">Mobile
              <input id="new_p_mobile" class="mt-1 w-full rounded-lg border px-3 py-2" placeholder="+14145550123 or (414) 555-0123"/>
            </label>
            <label class="text-sm">Email
              <input id="new_p_email" class="mt-1 w-full rounded-lg border px-3 py-2" placeholder="name@example.com"/>
            </label>
            <label class="text-sm">Birthday (YYYY-MM-DD)
              <input id="new_p_bday" class="mt-1 w-full rounded-lg border px-3 py-2" placeholder="1986-05-17"/>
            </label>
            <!-- role removed for 1-person households -->
          </div>
        </details>

        <div class="flex items-center justify-end gap-2 pt-2">
          <button type="button" id="cancelCreateBtn" class="px-3 py-2 rounded-lg bg-slate-200">Cancel</button>
          <button type="submit" id="createBtn" class="px-3 py-2 rounded-lg bg-emerald-600 text-white">Create</button>
        </div>
      </form>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getDatabase, ref, get, child, push, set, update } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";

    // 1) ðŸ”§ Firebase config (yours)
    const firebaseConfig = {
      apiKey: "AIzaSyAMio_EgHUFYi6-MxwlCdWoXEBsGxPPccU",
      authDomain: "keykraft-1fca4.firebaseapp.com",
      databaseURL: "https://keykraft-1fca4-default-rtdb.firebaseio.com",
      projectId: "keykraft-1fca4",
      storageBucket: "keykraft-1fca4.firebasestorage.app",
      messagingSenderId: "525295374203",
      appId: "1:525295374203:web:29a0484fc9e8b8ade1f7de",
      measurementId: "G-SJLXJS3784"
    };

    // 2) Init
    const app = initializeApp(firebaseConfig);
    const db  = getDatabase(app);

    // 3) UI handles
    const errEl  = document.getElementById("error");
    const statusEl = document.getElementById("status");
    const grid   = document.getElementById("grid");
    const qEl    = document.getElementById("q");
    const odEl   = document.getElementById("overdue");

    const openAddBtn = document.getElementById("openAddBtn");
    const closeAddBtn = document.getElementById("closeAddBtn");
    const cancelCreateBtn = document.getElementById("cancelCreateBtn");
    const hhModal = document.getElementById("hhModal");
    const form  = document.getElementById("hhCreateForm");

    // Household name auto-fill from person first+last (until user types their own)
    const hhNameEl = document.getElementById("new_hh_name");
    const pFirstEl = document.getElementById("new_p_first");
    const pLastEl  = document.getElementById("new_p_last");
    let autoName = true;
    hhNameEl.addEventListener("input", () => { autoName = hhNameEl.value.trim() === ""; });
    function syncHhNameFromPerson(){
      if (!autoName) return;
      const nm = `${(pFirstEl.value||"").trim()} ${(pLastEl.value||"").trim()}`.trim();
      hhNameEl.value = nm;
    }
    pFirstEl.addEventListener("input", syncHhNameFromPerson);
    pLastEl.addEventListener("input",  syncHhNameFromPerson);

    // 4) Helpers
    const today = new Date();
    const toISO = (d)=> d.toISOString().slice(0,10);
    function fmt(d){
      if (!d) return "â€”";
      const [y,m,day] = (d||"").split("-").map(Number);
      return (!y||!m||!day) ? d : `${m}/${day}/${y}`;
    }
    function chip(txt){
      return `<span class="text-[11px] px-2 py-0.5 rounded-full bg-indigo-50 text-indigo-700 border">${txt}</span>`;
    }
    const splitList = (s="") => (s||"").split(/[,;]+/).map(t=>t.trim()).filter(Boolean);

    // 5) Load households
    let households = {};
    async function loadHouseholds(){
      try {
        const snap = await get(ref(db, "households"));
        households = snap.exists() ? snap.val() : {};
        await hydrateMemberNames(households);
        render();
      } catch (e) {
        errEl.textContent = e.message;
        errEl.classList.remove("hidden");
      }
    }

    // 6) Member names: prefer cache; else fetch
    async function hydrateMemberNames(hhObj){
      const entries = Object.entries(hhObj || {});
      for (const [id, hh] of entries) {
        if (Array.isArray(hh.memberNamesCache) && hh.memberNamesCache.length){
          hh._memberNames = hh.memberNamesCache;
          continue;
        }
        const members = Object.entries(hh.members || {}).slice(0,4);
        const names = [];
        for (const [personId] of members) {
          try {
            const ps = await get(child(ref(db), `people/${personId}`));
            if (ps.exists()) {
              const p = ps.val();
              const first = p.preferredName || p.firstName || "";
              const last  = p.lastName || "";
              const full  = `${first} ${last}`.trim();
              if (full) names.push(full);
            }
          } catch { /* ignore */ }
        }
        hh._memberNames = names;
      }
    }

    // 7) Filtering + sorting
    function matches(hh, q, overdueOnly){
      q = (q||"").trim().toLowerCase();
      if (overdueOnly){
        const next = hh.nextSuggestedTouch;
        if (!next || next >= toISO(today)) return false;
      }
      if (!q) return true;

      const addr = hh.address ? [hh.address.city, hh.address.state].filter(Boolean).join(" ") : "";
      const tags = (hh.tags || []).join(" ");
      const members = (hh._memberNames || []).join(" ");
      const hay = [hh.displayName, addr, tags, members].filter(Boolean).join(" ").toLowerCase();
      return hay.includes(q);
    }

    function sortEntries(arr){
      return arr.sort((a,b)=>{
        const an = a[1].nextSuggestedTouch || "9999-12-31";
        const bn = b[1].nextSuggestedTouch || "9999-12-31";
        if (an !== bn) return an < bn ? -1 : 1;
        const aname = (a[1].displayName||"").toLowerCase();
        const bname = (b[1].displayName||"").toLowerCase();
        return aname.localeCompare(bname);
      });
    }

    // 8) Card renderer (clickable div instead of anchor)
    function card(id, hh){
      const city = [hh?.address?.city, hh?.address?.state].filter(Boolean).join(", ");
      const tags = (hh.tags||[]).slice(0,4).map(chip).join(" ");
      const members = (hh._memberNames||[]).slice(0,4).map(n=>{
        const first = n.split(" ")[0] || n;
        return chip(first);
      }).join(" ");

      return `
      <div onclick="location.href='./household.html?id=${encodeURIComponent(id)}'"
           class="cursor-pointer bg-white border rounded-2xl shadow-sm p-4 hover:shadow-md transition">
        <div class="flex items-center justify-between gap-3">
          <h3 class="font-semibold truncate" title="${hh.displayName||'Household'}">
            ${hh.displayName || "Household"}
          </h3>
          <span class="text-xs px-2 py-1 rounded bg-slate-100 border">Household</span>
        </div>
        <div class="text-sm text-slate-600 mt-1">${city || "â€”"}</div>
        <div class="mt-3 flex flex-wrap gap-1.5">${members || ""}</div>
        <div class="mt-2 flex flex-wrap gap-1.5">${tags}</div>
        <div class="mt-3 text-xs text-slate-600">
          <div><span class="font-medium">Last:</span> ${fmt(hh.lastTouch)}</div>
          <div><span class="font-medium">Next:</span> ${fmt(hh.nextSuggestedTouch)}</div>
        </div>
      </div>`;
    }

    // 9) Render
    function render(){
      const q = qEl.value;
      const overdueOnly = odEl.checked;

      const entries = Object.entries(households || {});
      const filtered = entries.filter(([id,hh])=> matches(hh, q, overdueOnly));
      const sorted = sortEntries(filtered);

      grid.innerHTML = sorted.map(([id,hh]) => card(id, hh)).join("") ||
        `<div class="col-span-full text-slate-600">No households match your filters.</div>`;
    }

    // 10) Wire up filters
    qEl.addEventListener("input", render);
    odEl.addEventListener("change", render);

    // 11) Add household modal handlers (use style.display to avoid overlay issues)
    function openModal(){ hhModal.style.display = 'flex'; form.reset(); autoName = true; }
    function closeModal(){ hhModal.style.display = 'none'; }
    openAddBtn.onclick = openModal;
    closeAddBtn.onclick = closeModal;
    cancelCreateBtn.onclick = closeModal;

    // 12) Create household + optional first person (no role needed for single person)
    form.onsubmit = async (e) => {
      e.preventDefault();
      errEl.textContent = ""; statusEl.textContent = "Creating householdâ€¦";

      // Household fields
      const hhName = document.getElementById("new_hh_name").value.trim();
      const cadence = Number(document.getElementById("new_cadence").value || 0);
      const street = document.getElementById("new_street").value.trim();
      const city   = document.getElementById("new_city").value.trim();
      const state  = document.getElementById("new_state").value.trim();
      const zip    = document.getElementById("new_zip").value.trim();
      const tags   = splitList(document.getElementById("new_tags").value);

      // Person fields (optional)
      const pFirst = document.getElementById("new_p_first").value.trim();
      const pLast  = document.getElementById("new_p_last").value.trim();
      const pMob   = document.getElementById("new_p_mobile").value.trim();
      const pEmail = document.getElementById("new_p_email").value.trim();
      const pBday  = document.getElementById("new_p_bday").value.trim();

      if (!hhName && !(pFirst || pLast)) {
        errEl.textContent = "Please provide a household name, or at least the first personâ€™s name.";
        return;
      }

      try {
        // Create household
        const hhRef = push(ref(db, "households"));
        const hhId = hhRef.key;
        const baseName = hhName || `${pFirst} ${pLast}`.trim() || "Household";

        const hhData = {
          displayName: baseName,
          address: { street, city, state, zip },
          tags,
          cadenceDays: cadence || null,
          lastTouch: null,
          nextSuggestedTouch: null,
          members: {},
          notes: "",
          memberNamesCache: []
        };

        await set(hhRef, hhData);

        // Optionally create first person and link (no role; mark primary)
        let memberNames = [];
        if (pFirst || pLast || pMob || pEmail || pBday) {
          const pRef = push(ref(db, "people"));
          const pid = pRef.key;
          await set(pRef, {
            firstName: pFirst, lastName: pLast, preferredName: pFirst || "",
            phones: pMob ? [{ value: pMob, label: "mobile", isPrimary: true }] : [],
            emails: pEmail ? [{ value: pEmail, label: "personal", isPrimary: true }] : [],
            birthday: pBday || "",
            interests: [],
            preferredChannel: "",
            custom: {}
          });

          memberNames = [`${pFirst} ${pLast}`.trim()].filter(Boolean);
          await update(ref(db), {
            [`/households/${hhId}/members/${pid}`]: { isPrimary: true },
            [`/households/${hhId}/memberNamesCache`]: memberNames
          });
        }

        closeModal();
        statusEl.textContent = "Household created.";
        await loadHouseholds();
        // Jump straight to the new household
        location.href = `./household.html?id=${hhRef.key}`;
      } catch (e) {
        errEl.textContent = e.message || String(e);
        statusEl.textContent = "";
      }
    };

    // Go!
    loadHouseholds();
  </script>
</body>
</html>
